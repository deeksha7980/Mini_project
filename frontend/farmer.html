<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Dashboard ‚Äî HerbChain</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: url("imgs/image.png") no-repeat center center fixed;
      background-size: cover;
      color: #222;
    }
    header {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 28px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(6px);
    }
    header h1 { font-size: 18px; color: #1b8a4c; margin: 0; font-weight: 600; }
    header button {
      background: #000; color: #fff; border: none; border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-size: 13px; font-weight: 500;
      transition: 0.2s;
    }
    header button:hover { background: #1b8a4c; }
    .main-box {
      max-width: 1100px; margin: 30px auto; background: transparent;
      border-radius: 16px; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      padding: 30px; backdrop-filter: blur(10px);
    }
    h2 { color: #f2f5f3; margin-bottom: 15px; }
    .content { display: flex; gap: 25px; flex-wrap: wrap; }
    .form-section { flex: 2; min-width: 320px; }
    .herbs-section {
      flex: 1; min-width: 250px; background: #f9fafb;
      border-radius: 10px; padding: 15px;
      box-shadow: inset 0 0 5px rgba(241,235,235,0.05);
    }
    .herbs-section h3 { color: #1b8a4c; margin-top: 0; text-align: center; }
    #cameraBox {
      position: relative; width: 50%; height: 230px; background: #e9ecef;
      border-radius: 10px; overflow: hidden;
    }
    video, img {
      position: absolute; width: 100%; height: 100%; object-fit: cover;
      top: 0; left: 0; border-radius: 10px;
    }
    #capture, #uploadPhoto {
      background: #1b8a4c; color: white; margin-top: 10px; border: none;
      padding: 9px; border-radius: 8px; cursor: pointer; width: 100%;
      font-weight: 600; font-size: 14px;
      font-family: 'Times New Roman', Times, serif; transition: 0.3s;
    }
    #capture:hover, #uploadPhoto:hover { background: #145a32; }
    .photo-buttons { display: flex; gap: 12px; margin-top: 10px; }
    input, button {
      width: 100%; padding: 9px; border: 1px solid #1b8a4c50;
      border-radius: 8px; font-size: 14px; margin-top: 6px;
    }
    label {
      font-weight: 500; margin-top: 10px; display: block; font-size: 14px;
      color: #ddd; font-family: 'Times New Roman', Times, serif;
    }
    #addHerbBtn {
      background: #000; color: white; font-weight: 600;
      margin-top: 15px; font-size: 14px;
    }
    #addHerbBtn:hover { background: #1b8a4c; }
    .herbItem {
      border: 1px solid #ddd; border-radius: 8px; padding: 8px 10px;
      margin-bottom: 8px; display: flex; justify-content: space-between;
      align-items: center; background: #fff; font-size: 14px;
    }
    .status { padding: 2px 8px; border-radius: 6px; font-size: 12px; text-transform: capitalize; }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.approved { background: #d4edda; color: #155724; }
    .status.rejected { background: #f8d7da; color: #721c24; }
    #toast {
      position: fixed; bottom: 20px; right: 20px; background: #1b8a4c;
      color: white; padding: 10px 20px; border-radius: 8px;
      opacity: 0; transition: opacity 0.3s ease-in-out; font-size: 14px;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
  <header>
    <h1>üåø AyurTrace ‚Äî Farmer Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="main-box">
    <h2>Add New Herb</h2>
    <div class="content">
      <div class="form-section">
        <div id="cameraBox">
          <video id="video" autoplay playsinline></video>
          <img id="preview" style="display:none;" />
        </div>
        <div class="photo-buttons">
          <button id="capture">üì∏ Capture</button>
          <button id="uploadPhoto">üì§ Upload</button>
        </div>
        <input type="file" id="photoInput" accept="image/*" style="display:none;" />
        <canvas id="canvas" style="display:none;"></canvas>

        <label>Herb Name *</label>
        <input type="text" id="herbName" placeholder="e.g., Ashwagandha" />
        <label>Location *</label>
        <input type="text" id="location" placeholder="e.g., Wayanad, Kerala" />
        <label>GPS Coordinates</label>
        <div style="display:flex;gap:8px;">
          <input type="text" id="latitude" placeholder="Latitude" readonly />
          <input type="text" id="longitude" placeholder="Longitude" readonly />
        </div>
        <button onclick="getLocation()">üìç Capture Location</button>
        <button id="addHerbBtn" onclick="submitHerb()">Add Herb</button>
      </div>

      <div class="herbs-section">
        <h3>My Herbs</h3>
        <div id="myHerbsList">Loading...</div>
      </div>
    </div>
  </div>

  <div id="toast">Herb added successfully!</div>

  <script>
    const farmerName = localStorage.getItem("farmerName") || "Deeksha S";
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("preview");
    const toast = document.getElementById("toast");

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(() => alert("Camera access denied."));

    document.getElementById("capture").onclick = () => {
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imageData = canvas.toDataURL("image/png");
      video.style.display = "none";
      preview.src = imageData;
      preview.style.display = "block";
      window.capturedImage = imageData;
    };

    document.getElementById("uploadPhoto").onclick = () => document.getElementById("photoInput").click();

    document.getElementById("photoInput").onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        preview.src = ev.target.result;
        preview.style.display = "block";
        video.style.display = "none";
        window.capturedImage = ev.target.result;
      };
      reader.readAsDataURL(file);
    };

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.getElementById("latitude").value = pos.coords.latitude.toFixed(6);
          document.getElementById("longitude").value = pos.coords.longitude.toFixed(6);
        });
      } else alert("Geolocation not supported.");
    }

    async function loadMyHerbs() {
      const res = await fetch("http://localhost:5000/api/farmers-local");
      const data = await res.json();
      const myHerbs = data.filter(h => h.farmerName === farmerName);
      const container = document.getElementById("myHerbsList");

      if (!myHerbs.length) {
        container.innerHTML = "<p style='color:#777;text-align:center;'>No herbs added yet.</p>";
        return;
      }

      container.innerHTML = "";
      myHerbs.forEach(h => {
        const div = document.createElement("div");
        div.className = "herbItem";
        const statusClass =
          h.status === "approved" ? "approved" :
          h.status === "rejected" ? "rejected" : "pending";
        div.innerHTML = `<span>${h.herbName}</span><span class="status ${statusClass}">${h.status}</span>`;
        container.appendChild(div);
      });
    }

    async function submitHerb() {
      const herbName = document.getElementById("herbName").value.trim();
      const latitude = document.getElementById("latitude").value;
      const longitude = document.getElementById("longitude").value;
      const image = window.capturedImage;
      if (!herbName || !image) return alert("Please fill all fields and upload/capture photo.");

      const body = { farmerName, herbName, latitude, longitude, image };
      await fetch("http://localhost:5000/api/farmer", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
      });
      showToast("Herb added successfully!");
      loadMyHerbs();
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function logout() {
      localStorage.removeItem("farmerName");
      window.location.href = "index.html";
    }

    loadMyHerbs();
  </script>
</body>
</html>