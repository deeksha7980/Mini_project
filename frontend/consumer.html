<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HerbChain â€” Consumer</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QR generator for certificate -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <style>
    body {
      font-family: 'Times New Roman', serif;
      background: url("imgs/consumer.png") no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: rgba(27,138,76,0.9);
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 20px;
    }
    .card {
      background: rgba(255,255,255,0.96);
      color: #000;
      border-radius: 16px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      max-width: 820px;
      width: 100%;
      padding: 30px 40px;
      text-align: left;
      backdrop-filter: blur(10px);
    }
    h1 { color: #1b8a4c; text-align:center; margin-top:0; }
    img {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 15px;
      border: 1px solid #ccc;
    }
    .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: bold;
      margin-left: 6px;
      text-transform: capitalize;
      font-size: 14px;
    }
    .status.pending { background:#fff3cd; color:#856404; }
    .status.approved { background:#d4edda; color:#155724; }
    .status.rejected { background:#f8d7da; color:#721c24; }
    .certificate {
      margin-top: 12px;
      padding: 12px;
      background: #f6fdf6;
      border: 1px solid #e2ece1;
      border-radius: 8px;
      white-space: pre-wrap;
    }
    #downloadBtn {
      display: inline-block;
      background: #1b8a4c;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      margin-top: 18px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.25s;
    }
    #downloadBtn:hover { background:#146c43; }
    footer {
      text-align: center;
      color: rgba(255,255,255,0.95);
      padding: 15px;
      background: rgba(0,0,0,0.35);
      margin-top: auto;
      backdrop-filter: blur(10px);
    }

    .meta-row { display:flex; gap:24px; flex-wrap:wrap; }
    .meta-item { min-width: 180px; }
  </style>
</head>

<body>
  <header>
    <div>ðŸ§¾ HerbChain â€” <b>Consumer</b></div>
  </header>

  <div class="main">
    <div class="card">
      <h1>Herb Details</h1>
      <div id="resultBox">Loading herb data...</div>
    </div>
  </div>

  <footer>Â© HerbChain â€” Consumer Traceability Portal</footer>

  <script>
    // Auto-detect backend base URL
    const API_BASE = window.location.hostname.includes("loclx.io")
      ? window.location.origin.replace("/frontend", "")
      : (window.location.hostname === "localhost" ? "http://localhost:5000" : window.location.origin);

    // Utility: build a usable image URL pointing to backend/server/uploads
    function imageUrlFromStored(photoUrl) {
      if (!photoUrl) return null;

      const url = photoUrl.trim();

      // 1) Already an absolute URL -> use as-is
      if (url.startsWith("http://") || url.startsWith("https://")) return url;

      // 2) Relative path starting with /uploads -> attach API_BASE
      if (url.startsWith("/uploads")) return `${API_BASE}${url}`;

      // 3) Plain filename (no slashes) -> assume it's in uploads
      return `${API_BASE}/uploads/${url}`;
    }

    async function loadHerb() {
      const params = new URLSearchParams(window.location.search);
      const batch = params.get("batch");
      const box = document.getElementById("resultBox");

      if (!batch) {
        box.innerHTML = "âŒ Invalid QR or missing batch ID.";
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/farmers-local?nocache=${Date.now()}`);
        if (!res.ok) throw new Error("Failed to fetch backend data");
        const herbs = await res.json();
        const herb = herbs.find(h => h.herbId === batch);

        if (!herb) {
          box.innerHTML = "<b>No record found for this herb.</b>";
          return;
        }

        // Resolve photo URL robustly
        const photoSrc = imageUrlFromStored(herb.photoUrl);

        const statusClass = (herb.status || "pending").toLowerCase();

        // Build meta rows
        const locationText = (herb.latitude || "") + (herb.longitude ? ", " + herb.longitude : "");
        const labNameText = herb.labName || "â€”";
        const certificateText = herb.certificate || "No remarks available.";

        box.innerHTML = `
          <div class="meta-row">
            <div class="meta-item"><b>Name:</b><div>${herb.herbName || "â€”"}</div></div>
            <div class="meta-item"><b>Batch ID:</b><div>${herb.herbId || "â€”"}</div></div>
            <div class="meta-item"><b>Status:</b><div><span class="status ${statusClass}">${herb.status || "pending"}</span></div></div>
          </div>

          <div style="margin-top:12px;" class="meta-row">
            <div class="meta-item"><b>Farmer:</b><div>${herb.farmerName || "â€”"}</div></div>
            <div class="meta-item"><b>Location:</b><div>${locationText || "â€”"}</div></div>
            <div class="meta-item"><b>Lab Verified By:</b><div>${labNameText}</div></div>
          </div>

          <p style="margin-top:14px;"><b>Certificate / Remarks:</b></p>
          <div class="certificate">${certificateText}</div>

          ${photoSrc ? `<img id="herbPhoto" src="${photoSrc}" alt="Herb Photo">` : ""}
          ${herb.status === "approved" ? `<div><button id="downloadBtn">ðŸ“œ Download Certificate</button></div>` : ""}
        `;

        if (herb.status === "approved") {
          document.getElementById("downloadBtn").addEventListener("click", () => downloadCertificate(herb, photoSrc));
        }

        // If image exists but fails to load (CORS/tunnel issues), attempt fallback by trying direct uploads path
        const imgEl = document.getElementById("herbPhoto");
        if (imgEl) {
          imgEl.onerror = () => {
            console.warn("Image failed to load, trying fallback path...");
            // Attempt fallback: if API_BASE is loclx origin, try forcing PUBLIC-style path
            const fallback = `${API_BASE}/uploads/${(herb.photoUrl || "").split("/").pop()}`;
            if (fallback !== imgEl.src) imgEl.src = fallback;
          };
        }

      } catch (err) {
        console.error("Error loading herb:", err);
        box.innerHTML = "<b>Error loading herb data. Check console for details.</b>";
      }
    }

    // Improved certificate generator (authentic look + QR + herb photo)
    async function downloadCertificate(herb, photoSrc) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

      // Page background (subtle textured color)
      doc.setFillColor(255, 253, 245);
      doc.rect(0, 0, 842, 595, "F");

      // Gold decorative border
      doc.setDrawColor(184, 134, 11);
      doc.setLineWidth(8);
      doc.rect(18, 18, 806, 560);

      // Inner lighter border
      doc.setDrawColor(230, 230, 220);
      doc.setLineWidth(2);
      doc.rect(32, 32, 772, 526);

      // Title
      doc.setFont("times", "bold");
      doc.setFontSize(34);
      doc.setTextColor(20, 85, 45);
      doc.text("AYURTRACE QUALITY CERTIFICATE", 421, 92, { align: "center" });

      // Subtitle
      doc.setFont("times", "italic");
      doc.setFontSize(14);
      doc.setTextColor(80);
      doc.text("Authenticity & Quality Verification â€” Official Record", 421, 116, { align: "center" });

      // Details area
      const leftX = 72;
      let curY = 160;
      const gap = 28;

      doc.setFont("times", "normal");
      doc.setFontSize(16);
      doc.setTextColor(8, 8, 8);

      doc.text(`Herb Name: ${herb.herbName || "â€”"}`, leftX, curY);
      doc.text(`Batch ID: ${herb.herbId || "â€”"}`, leftX, curY += gap);
      doc.text(`Farmer: ${herb.farmerName || "â€”"}`, leftX, curY += gap);
      const loc = (herb.latitude || "") + (herb.longitude ? ", " + herb.longitude : "");
      doc.text(`Origin (lat,long): ${loc || "â€”"}`, leftX, curY += gap);
      doc.text(`Verified By: ${herb.labName || "â€”"}`, leftX, curY += gap);
      doc.text(`Verified On: ${new Date(herb.labTimestamp || Date.now()).toLocaleString()}`, leftX, curY += gap);

      // Remarks box
      doc.setFont("times", "italic");
      doc.setFontSize(14);
      doc.text("Laboratory Remarks:", leftX, curY + gap);
      doc.setFont("times", "normal");
      doc.setFontSize(12);
      doc.text(herb.certificate || "Approved for quality assurance.", leftX, curY + gap + 18, { maxWidth: 380 });

      // QR code (authenticity)
      const qrCanvas = document.createElement("canvas");
      const qr = new QRious({
        element: qrCanvas,
        value: JSON.stringify({ batch: herb.herbId, verifiedBy: herb.labName, ts: herb.labTimestamp }),
        size: 140
      });
      const qrDataUrl = qrCanvas.toDataURL("image/png");
      doc.addImage(qrDataUrl, "PNG", 622, 142, 140, 140);

      // Seal / Verified badge
      doc.setFont("times", "bold");
      doc.setFontSize(20);
      doc.setTextColor(184, 134, 11);
      doc.text("âœ” VERIFIED", 650, 310, { align: "center" });

      // Herb photo on right (if available)
      if (photoSrc) {
        // Try to fetch image and add to PDF (with CORS enabled)
        try {
          await addImageToPdf(doc, photoSrc, 600, 330, 200, 140);
        } catch (e) {
          console.warn("Could not add herb photo to PDF:", e);
        }
      }

      // Signature area
      doc.setFont("times", "italic");
      doc.setFontSize(14);
      doc.setTextColor(40);
      doc.text("Authorized Signatory", 540, 520, { align: "left" });
      doc.setDrawColor(200);
      doc.setLineWidth(1);
      doc.line(540, 522, 720, 522); // signature line

      // Footer small print
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text("This certificate is digitally generated by AyurTrace and is valid unless tampered.", 421, 560, { align: "center" });

      // Save
      doc.save(`${herb.herbId}_AyurTrace_Certificate.pdf`);
    }

    // Helper: load image and add to jsPDF (returns Promise)
    function addImageToPdf(doc, src, x, y, w, h) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          try {
            // convert to canvas to ensure consistent format
            const canvas = document.createElement("canvas");
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
            doc.addImage(dataUrl, "JPEG", x, y, w, h);
            resolve();
          } catch (e) {
            reject(e);
          }
        };
        img.onerror = (e) => reject(new Error("Image load failed"));
        img.src = src;
      });
    }

    window.addEventListener("load", loadHerb);
  </script>
</body>
</html>
